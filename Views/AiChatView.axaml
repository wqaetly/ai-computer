<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AiComputer.ViewModels"
             xmlns:models="using:AiComputer.Models"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:content="using:SukiUI.Content"
             xmlns:md="clr-namespace:LiveMarkdown.Avalonia;assembly=LiveMarkdown.Avalonia"
             xmlns:iconPacks="https://github.com/MahApps/IconPacks.Avalonia"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="AiComputer.Views.AiChatView"
             x:DataType="vm:AiChatViewModel">

    <Design.DataContext>
        <vm:AiChatViewModel />
    </Design.DataContext>

    <!-- ä¸»å¸ƒå±€ï¼šå¯¹è¯åˆ—è¡¨ + å¯¹è¯å†…å®¹ -->
    <Grid ColumnDefinitions="Auto,*">

        <!-- å·¦ä¾§ï¼šå¯¹è¯åˆ—è¡¨ä¾§è¾¹æ  -->
        <Border Grid.Column="0"
                Background="{DynamicResource SukiBackground}"
                BorderBrush="{DynamicResource SukiBorderBrush}"
                BorderThickness="0,0,1,0"
                Width="260">
            <Grid RowDefinitions="Auto,*">

                <!-- å¯¹è¯åˆ—è¡¨å¤´éƒ¨ -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SukiCardBackground}"
                        BorderBrush="{DynamicResource SukiBorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="12,10">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0"
                                   Text="å¯¹è¯åˆ—è¡¨"
                                   FontSize="13"
                                   FontWeight="Bold"
                                   VerticalAlignment="Center" />

                        <!-- æ–°å»ºå¯¹è¯æŒ‰é’® -->
                        <Button Grid.Column="1"
                                Command="{Binding CreateNewSessionCommand}"
                                Classes="Basic"
                                Padding="0"
                                Width="18"
                                Height="18"
                                ToolTip.Tip="æ–°å»ºå¯¹è¯"
                                VerticalAlignment="Center"
                                Margin="-2,0,0,0">
                            <iconPacks:PackIconMaterial Kind="Plus"
                                                        Width="14"
                                                        Height="14" />
                        </Button>
                    </Grid>
                </Border>

                <!-- å¯¹è¯åˆ—è¡¨ -->
                <ListBox Grid.Row="1"
                         ItemsSource="{Binding Sessions}"
                         SelectedItem="{Binding CurrentSession, Mode=TwoWay}"
                         Background="Transparent"
                         SelectionMode="Single"
                         Padding="8">
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                            <Setter Property="Padding" Value="10,8" />
                            <Setter Property="Margin" Value="0,0,0,2" />
                            <Setter Property="CornerRadius" Value="6" />
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="BorderThickness" Value="1" />
                            <Setter Property="BorderBrush" Value="Transparent" />
                        </Style>
                        <!-- éšè—é»˜è®¤çš„å‹¾é€‰æ ‡è®° -->
                        <Style Selector="ListBoxItem /template/ ContentPresenter#PART_ContentPresenter">
                            <Setter Property="Background" Value="Transparent" />
                        </Style>
                        <!-- éšè—æ‰€æœ‰å¯èƒ½çš„å‹¾é€‰æ ‡è®°å…ƒç´  -->
                        <Style Selector="ListBoxItem /template/ PathIcon">
                            <Setter Property="IsVisible" Value="False" />
                        </Style>
                        <Style Selector="ListBoxItem /template/ Border#SelectionIndicator">
                            <Setter Property="IsVisible" Value="False" />
                        </Style>
                        <Style Selector="ListBoxItem /template/ Border#PART_SelectedBorder">
                            <Setter Property="IsVisible" Value="False" />
                        </Style>
                        <Style Selector="ListBoxItem /template/ Viewbox">
                            <Setter Property="IsVisible" Value="False" />
                        </Style>
                        <!-- æ‚¬åœçŠ¶æ€ -->
                        <Style Selector="ListBoxItem:pointerover">
                            <Setter Property="Background" Value="{DynamicResource SukiCardBackground}" />
                            <Setter Property="BorderBrush" Value="{DynamicResource SukiBorderBrush}" />
                        </Style>
                        <!-- é€‰ä¸­çŠ¶æ€ - ä½¿ç”¨è¾¹æ¡†å’ŒèƒŒæ™¯è‰²è¡¨ç¤º -->
                        <Style Selector="ListBoxItem:selected">
                            <Setter Property="Background" Value="{DynamicResource SukiCardBackground}" />
                            <Setter Property="BorderBrush" Value="{DynamicResource SukiPrimaryColor}" />
                        </Style>
                        <Style Selector="ListBoxItem:selected /template/ ContentPresenter#PART_ContentPresenter">
                            <Setter Property="Background" Value="Transparent" />
                        </Style>
                        <!-- æ–‡å­—é»˜è®¤çŠ¶æ€ -->
                        <Style Selector="ListBoxItem TextBlock">
                            <Setter Property="Foreground" Value="{DynamicResource SukiText}" />
                            <Setter Property="Opacity" Value="0.8" />
                        </Style>
                        <!-- æ–‡å­—æ‚¬åœçŠ¶æ€ -->
                        <Style Selector="ListBoxItem:pointerover TextBlock">
                            <Setter Property="Foreground" Value="{DynamicResource SukiText}" />
                            <Setter Property="Opacity" Value="1" />
                        </Style>
                        <!-- æ–‡å­—é€‰ä¸­çŠ¶æ€ -->
                        <Style Selector="ListBoxItem:selected TextBlock">
                            <Setter Property="Foreground" Value="{DynamicResource SukiText}" />
                            <Setter Property="Opacity" Value="1" />
                            <Setter Property="FontWeight" Value="Medium" />
                        </Style>
                    </ListBox.Styles>
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="models:ChatSession">
                            <!-- ç®€åŒ–ä¸ºå•å±‚å¸ƒå±€ -->
                            <TextBlock Text="{Binding Title}"
                                       FontSize="13"
                                       TextTrimming="CharacterEllipsis"
                                       MaxLines="1"
                                       VerticalAlignment="Center">
                                <!-- å³é”®èœå• -->
                                <TextBlock.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="é‡å‘½å"
                                                  Command="{Binding $parent[UserControl].((vm:AiChatViewModel)DataContext).RenameSessionCommand}"
                                                  CommandParameter="{Binding}" />
                                        <Separator />
                                        <MenuItem Header="åˆ é™¤"
                                                  Command="{Binding $parent[UserControl].((vm:AiChatViewModel)DataContext).DeleteSessionCommand}"
                                                  CommandParameter="{Binding}" />
                                    </ContextMenu>
                                </TextBlock.ContextMenu>
                            </TextBlock>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- å³ä¾§ï¼šå¯¹è¯å†…å®¹åŒºåŸŸ -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
            <!-- æ ‡é¢˜æ  -->
            <Border Grid.Row="0" Background="{DynamicResource SukiBackground}" Padding="20,15">
                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="{Binding CurrentSession.Title, FallbackValue='çŽ„æœºé‰´ AI åˆ†æžå¸ˆ'}"
                                   FontSize="20"
                                   FontWeight="Bold" />
                        <TextBlock Text="ä¸“ä¸šç”µè„‘ç¡¬ä»¶é…ç½®åˆ†æžä¸Žè£…æœºæ–¹æ¡ˆæŽ¨è"
                                   FontSize="12"
                                   Opacity="0.7"
                                   Margin="0,4,0,0" />
                    </StackPanel>

                    <Button Grid.Column="1"
                            Content="æ¸…ç©ºå¯¹è¯"
                            Command="{Binding ClearMessagesCommand}"
                            Classes="Basic"
                            VerticalAlignment="Center" />
                </Grid>
            </Border>

            <!-- å†…å®¹åŒºåŸŸ -->
            <Grid Grid.Row="1">
                <!-- æ¬¢è¿Žç•Œé¢ -->
                <Grid IsVisible="{Binding ShowWelcomeScreen}"
                      VerticalAlignment="Center"
                      HorizontalAlignment="Center">
                    <suki:GlassCard MaxWidth="500" Padding="30,25">
                        <StackPanel Spacing="12" HorizontalAlignment="Center">
                            <!-- å¤§æ ‡é¢˜ -->
                            <TextBlock Text="âš™ï¸ çŽ„æœºé‰´ AI åˆ†æžå¸ˆ"
                                       FontSize="24"
                                       FontWeight="Bold"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource SukiPrimaryColor}" />

                            <!-- å‰¯æ ‡é¢˜ -->
                            <TextBlock Text="ä¸“ä¸šç”µè„‘ç¡¬ä»¶é…ç½®åˆ†æžä¸Žè£…æœºæ–¹æ¡ˆæŽ¨è"
                                       FontSize="12"
                                       Opacity="0.8"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,8" />

                            <!-- åˆ†éš”çº¿ -->
                            <Separator Margin="0,4,0,8" />

                            <!-- æ¬¢è¿Žå†…å®¹ -->
                            <Border>
                                <TextBlock TextWrapping="Wrap"
                                           FontSize="13"
                                           LineHeight="20"
                                           Opacity="0.9"
                                           HorizontalAlignment="Left">
                                    <Run Text="&#10;" />
                                    <Run Text="ðŸŽ¯ " FontSize="14" />
                                    <Run Text="æ ¸å¿ƒåŠŸèƒ½" FontWeight="Bold" FontSize="14" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ " />
                                    <Run Text="é…ç½®è¯„ä¼°ï¼š" FontWeight="Bold" />
                                    <Run Text="åˆ†æžç¡¬ä»¶é…ç½®ï¼Œè¯†åˆ«ç“¶é¢ˆ" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ " />
                                    <Run Text="è£…æœºæ–¹æ¡ˆï¼š" FontWeight="Bold" />
                                    <Run Text="æä¾›é…ç½®æ¸…å•å’Œè´­ä¹°æ¸ é“" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ " />
                                    <Run Text="å®žæ—¶ä»·æ ¼ï¼š" FontWeight="Bold" />
                                    <Run Text="æŸ¥è¯¢äº¬ä¸œã€æ·˜å®æœ€æ–°ä»·æ ¼" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ " />
                                    <Run Text="æ€§èƒ½æµ‹è¯•ï¼š" FontWeight="Bold" />
                                    <Run Text="èŽ·å–ç¡¬ä»¶æ€§èƒ½æµ‹è¯•æ•°æ®" />
                                    <Run Text="&#10;&#10;" />
                                    <Run Text="ðŸ’¡ " FontSize="14" />
                                    <Run Text="ä½¿ç”¨ç¤ºä¾‹" FontWeight="Bold" FontSize="14" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ RTX 4060 + i5-13400F çŽ© 4K æ¸¸æˆä¼šå¡å—ï¼Ÿ" FontStyle="Italic" FontSize="12" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ 8000 å…ƒé¢„ç®—å¸®æˆ‘é…ä¸€å°ç¼–ç¨‹å»ºæ¨¡ä¸»æœº" FontStyle="Italic" FontSize="12" />
                                    <Run Text="&#10;" />
                                    <Run Text="â€¢ RTX 4070 Ti å’Œ RX 7900 XT å“ªä¸ªæ€§ä»·æ¯”é«˜ï¼Ÿ" FontStyle="Italic" FontSize="12" />
                                    <Run Text="&#10;&#10;" />
                                    <Run Text="ðŸš€ " FontSize="14" />
                                    <Run Text="å¼€å§‹å¯¹è¯" FontWeight="Bold" FontSize="14" />
                                    <Run Text="&#10;" />
                                    <Run Text="è¾“å…¥é…ç½®æˆ–éœ€æ±‚ï¼ŒæŒ‰ " FontSize="12" />
                                    <Run Text="Ctrl+Enter" FontWeight="Bold" Foreground="{DynamicResource SukiPrimaryColor}" FontSize="12" />
                                    <Run Text=" å‘é€" FontSize="12" />
                                </TextBlock>
                            </Border>
                        </StackPanel>
                    </suki:GlassCard>
                </Grid>

                <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                <ScrollViewer IsVisible="{Binding !ShowWelcomeScreen}"
                              Padding="20,20,20,0"
                              Name="MessageScrollViewer"
                              ScrollChanged="MessageScrollViewer_OnScrollChanged">
                    <ItemsControl ItemsSource="{Binding Messages}" Margin="0,0,0,40">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="models:ChatMessage">
                                <Grid Margin="0,0,0,15">
                                    <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                                    <StackPanel IsVisible="{Binding IsUser}" Margin="50,0,10,0">
                                        <Border Background="{DynamicResource SukiPrimaryColor}"
                                                CornerRadius="12"
                                                Padding="15"
                                                HorizontalAlignment="Right"
                                                MaxWidth="700">
                                            <!-- Markdown æ¸²æŸ“å™¨ -->
                                            <md:MarkdownRenderer MarkdownBuilder="{Binding ContentBuilder}" />
                                        </Border>
                                        <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                                   FontSize="11"
                                                   Opacity="0.6"
                                                   HorizontalAlignment="Right"
                                                   Margin="0,5,0,0" />
                                    </StackPanel>

                                    <!-- AI åŠ©æ‰‹æ¶ˆæ¯ -->
                                    <StackPanel IsVisible="{Binding IsAssistant}" Margin="10,0,50,0">
                                        <!-- æœç´¢ç»“æžœæ°”æ³¡ï¼ˆç‰¹æ®Šæ ·å¼ï¼‰ -->
                                        <Border IsVisible="{Binding IsSearchResult}"
                                                Background="#15A3E6F5"
                                                BorderBrush="#40A3E6F5"
                                                BorderThickness="1"
                                                CornerRadius="12"
                                                Padding="15"
                                                HorizontalAlignment="Stretch">
                                            <StackPanel>
                                                <!-- æœç´¢æ ‡é¢˜å’Œå±•å¼€/æ”¶èµ·æŒ‰é’® -->
                                                <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,10">
                                                    <iconPacks:PackIconMaterial Grid.Column="0"
                                                                                Kind="Web"
                                                                                Width="16"
                                                                                Height="16"
                                                                                VerticalAlignment="Center"
                                                                                Foreground="#4A9EFF"
                                                                                Margin="0,0,8,0" />
                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding StatusText}"
                                                               FontSize="12"
                                                               FontWeight="Medium"
                                                               Foreground="#4A9EFF"
                                                               VerticalAlignment="Center" />
                                                    <Button Grid.Column="2"
                                                            Content="{Binding IsSearchResultExpanded, Converter={StaticResource SearchResultButtonConverter}}"
                                                            Command="{Binding $parent[UserControl].((vm:AiChatViewModel)DataContext).ToggleSearchResultCommand}"
                                                            CommandParameter="{Binding}"
                                                            Classes="Basic"
                                                            Padding="6,2"
                                                            FontSize="11" />
                                                </Grid>

                                                <!-- å±•å¼€çš„æœç´¢ç»“æžœå†…å®¹ -->
                                                <Border IsVisible="{Binding IsSearchResultExpanded}"
                                                        BorderBrush="#30A3E6F5"
                                                        BorderThickness="0,1,0,0"
                                                        Padding="0,10,0,0">
                                                    <md:MarkdownRenderer MarkdownBuilder="{Binding ContentBuilder}" />
                                                </Border>
                                            </StackPanel>
                                        </Border>

                                        <!-- æ™®é€šAIå›žç­”æ°”æ³¡ -->
                                        <suki:GlassCard IsVisible="{Binding !IsSearchResult}"
                                                        HorizontalAlignment="Stretch">
                                            <StackPanel>
                                                <!-- æŽ¨ç†å†…å®¹ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰ -->
                                                <Border IsVisible="{Binding HasReasoning}"
                                                        Background="{DynamicResource SukiCardBackground}"
                                                        CornerRadius="8"
                                                        Padding="12"
                                                        Margin="0,0,0,10">
                                                    <StackPanel>
                                                        <Button Content="{Binding IsReasoningExpanded, Converter={StaticResource ReasoningButtonConverter}}"
                                                                Command="{Binding $parent[UserControl].((vm:AiChatViewModel)DataContext).ToggleReasoningCommand}"
                                                                CommandParameter="{Binding}"
                                                                Classes="Basic"
                                                                HorizontalAlignment="Left"
                                                                Padding="8,4" />

                                                        <!-- å±•å¼€çš„æ€è€ƒå†…å®¹ -->
                                                        <Border IsVisible="{Binding IsReasoningExpanded}"
                                                                Margin="0,10,0,0">
                                                            <ScrollViewer Name="ReasoningScrollViewer"
                                                                          MaxHeight="300"
                                                                          HorizontalScrollBarVisibility="Disabled"
                                                                          SizeChanged="ReasoningScrollViewer_OnSizeChanged"
                                                                          Tag="{Binding}">
                                                                <!-- Markdown æ¸²æŸ“å™¨ -->
                                                                <md:MarkdownRenderer MarkdownBuilder="{Binding ReasoningContentBuilder}" />
                                                            </ScrollViewer>
                                                        </Border>
                                                    </StackPanel>
                                                </Border>

                                                <!-- å›žç­”å†…å®¹ -->
                                                <Border IsVisible="{Binding HasContent}">
                                                    <!-- Markdown æ¸²æŸ“å™¨ -->
                                                    <md:MarkdownRenderer MarkdownBuilder="{Binding ContentBuilder}" />
                                                </Border>
                                            </StackPanel>
                                        </suki:GlassCard>

                                        <!-- æ—¶é—´æˆ³å’ŒçŠ¶æ€ -->
                                        <StackPanel Orientation="Horizontal"
                                                   HorizontalAlignment="Left"
                                                   Margin="15,5,0,0"
                                                   Spacing="8">
                                            <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                                      FontSize="11"
                                                      Opacity="0.6" />

                                            <!-- AI çŠ¶æ€æ ‡è¯†ï¼ˆä»…éžæœç´¢ç»“æžœæ˜¾ç¤ºï¼‰ -->
                                            <TextBlock Text="{Binding StatusText}"
                                                      FontSize="11"
                                                      Opacity="0.7"
                                                      Foreground="{DynamicResource SukiPrimaryColor}"
                                                      FontWeight="Medium"
                                                      IsVisible="{Binding ShowStatus}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <!-- è¾“å…¥æ¡† -->
            <Border Grid.Row="2"
                    Background="{DynamicResource SukiBackground}"
                    BorderBrush="{DynamicResource SukiBorderBrush}"
                    BorderThickness="0,1,0,0"
                    Padding="20">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
                    <TextBox Grid.Column="0"
                             Text="{Binding InputMessage, Mode=TwoWay}"
                             Watermark="è¾“å…¥æ‚¨çš„ç¡¬ä»¶é…ç½®æˆ–è£…æœºéœ€æ±‚... (æ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒCtrl+Enter å‘é€)"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             MaxHeight="120"
                             VerticalAlignment="Center">
                        <TextBox.KeyBindings>
                            <KeyBinding Gesture="Ctrl+Enter" Command="{Binding SendOrStopCommand}" />
                        </TextBox.KeyBindings>
                    </TextBox>

                    <!-- å‘é€/åœæ­¢æŒ‰é’® -->
                    <Button Grid.Column="1"
                            Content="{Binding SendButtonText}"
                            Command="{Binding SendOrStopCommand}"
                            suki:ButtonExtensions.ShowProgress="{Binding IsSending}"
                            Margin="10,0,0,0"
                            Classes="Accent"
                            VerticalAlignment="Center" />
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
