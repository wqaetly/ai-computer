<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AiComputer.ViewModels"
             xmlns:models="using:AiComputer.Models"
             xmlns:suki="clr-namespace:SukiUI.Controls;assembly=SukiUI"
             xmlns:md="clr-namespace:LiveMarkdown.Avalonia;assembly=LiveMarkdown.Avalonia"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="AiComputer.Views.AiChatView"
             x:DataType="vm:AiChatViewModel">

    <Design.DataContext>
        <vm:AiChatViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- æ ‡é¢˜æ  -->
        <Border Grid.Row="0" Background="{DynamicResource SukiBackground}" Padding="20,15">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0">
                    <TextBlock Text="çŽ„æœºé‰´ AI åˆ†æžå¸ˆ" FontSize="20" FontWeight="Bold" />
                    <TextBlock Text="ä¸“ä¸šç”µè„‘ç¡¬ä»¶é…ç½®åˆ†æžä¸Žè£…æœºæ–¹æ¡ˆæŽ¨è" FontSize="12" Opacity="0.7" Margin="0,4,0,0" />
                </StackPanel>

                <Button Grid.Column="1"
                        Content="æ¸…ç©ºå¯¹è¯"
                        Command="{Binding ClearMessagesCommand}"
                        Classes="Basic"
                        VerticalAlignment="Center" />
            </Grid>
        </Border>

        <!-- å†…å®¹åŒºåŸŸ -->
        <Grid Grid.Row="1">
            <!-- æ¬¢è¿Žç•Œé¢ -->
            <Grid IsVisible="{Binding ShowWelcomeScreen}"
                  VerticalAlignment="Center"
                  HorizontalAlignment="Center">
                <suki:GlassCard MaxWidth="500" Padding="30,25">
                    <StackPanel Spacing="12" HorizontalAlignment="Center">
                        <!-- å¤§æ ‡é¢˜ -->
                        <TextBlock Text="âš™ï¸ çŽ„æœºé‰´ AI åˆ†æžå¸ˆ"
                                   FontSize="24"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SukiPrimaryColor}" />

                        <!-- å‰¯æ ‡é¢˜ -->
                        <TextBlock Text="ä¸“ä¸šç”µè„‘ç¡¬ä»¶é…ç½®åˆ†æžä¸Žè£…æœºæ–¹æ¡ˆæŽ¨è"
                                   FontSize="12"
                                   Opacity="0.8"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,8" />

                        <!-- åˆ†éš”çº¿ -->
                        <Separator Margin="0,4,0,8" />

                        <!-- æ¬¢è¿Žå†…å®¹ -->
                        <Border>
                            <TextBlock TextWrapping="Wrap"
                                       FontSize="13"
                                       LineHeight="20"
                                       Opacity="0.9"
                                       HorizontalAlignment="Left">
                                <Run Text="&#10;" />
                                <Run Text="ðŸŽ¯ " FontSize="14" />
                                <Run Text="æ ¸å¿ƒåŠŸèƒ½" FontWeight="Bold" FontSize="14" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ " />
                                <Run Text="é…ç½®è¯„ä¼°ï¼š" FontWeight="Bold" />
                                <Run Text="åˆ†æžç¡¬ä»¶é…ç½®ï¼Œè¯†åˆ«ç“¶é¢ˆ" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ " />
                                <Run Text="è£…æœºæ–¹æ¡ˆï¼š" FontWeight="Bold" />
                                <Run Text="æä¾›é…ç½®æ¸…å•å’Œè´­ä¹°æ¸ é“" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ " />
                                <Run Text="å®žæ—¶ä»·æ ¼ï¼š" FontWeight="Bold" />
                                <Run Text="æŸ¥è¯¢äº¬ä¸œã€æ·˜å®æœ€æ–°ä»·æ ¼" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ " />
                                <Run Text="æ€§èƒ½æµ‹è¯•ï¼š" FontWeight="Bold" />
                                <Run Text="èŽ·å–ç¡¬ä»¶æ€§èƒ½æµ‹è¯•æ•°æ®" />
                                <Run Text="&#10;&#10;" />
                                <Run Text="ðŸ’¡ " FontSize="14" />
                                <Run Text="ä½¿ç”¨ç¤ºä¾‹" FontWeight="Bold" FontSize="14" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ RTX 4060 + i5-13400F çŽ© 4K æ¸¸æˆä¼šå¡å—ï¼Ÿ" FontStyle="Italic" FontSize="12" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ 8000 å…ƒé¢„ç®—å¸®æˆ‘é…ä¸€å°ç¼–ç¨‹å»ºæ¨¡ä¸»æœº" FontStyle="Italic" FontSize="12" />
                                <Run Text="&#10;" />
                                <Run Text="â€¢ RTX 4070 Ti å’Œ RX 7900 XT å“ªä¸ªæ€§ä»·æ¯”é«˜ï¼Ÿ" FontStyle="Italic" FontSize="12" />
                                <Run Text="&#10;&#10;" />
                                <Run Text="ðŸš€ " FontSize="14" />
                                <Run Text="å¼€å§‹å¯¹è¯" FontWeight="Bold" FontSize="14" />
                                <Run Text="&#10;" />
                                <Run Text="è¾“å…¥é…ç½®æˆ–éœ€æ±‚ï¼ŒæŒ‰ " FontSize="12" />
                                <Run Text="Ctrl+Enter" FontWeight="Bold" Foreground="{DynamicResource SukiPrimaryColor}" FontSize="12" />
                                <Run Text=" å‘é€" FontSize="12" />
                            </TextBlock>
                        </Border>
                    </StackPanel>
                </suki:GlassCard>
            </Grid>

            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <ScrollViewer IsVisible="{Binding !ShowWelcomeScreen}"
                          Padding="20"
                          Name="MessageScrollViewer">
                <ItemsControl ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="models:ChatMessage">
                            <Grid Margin="0,0,0,15">
                                <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                                <StackPanel IsVisible="{Binding IsUser}">
                                    <Border Background="{DynamicResource SukiPrimaryColor}"
                                            CornerRadius="12"
                                            Padding="15"
                                            HorizontalAlignment="Right"
                                            MaxWidth="600">
                                        <!-- Markdown æ¸²æŸ“å™¨ -->
                                        <md:MarkdownRenderer MarkdownBuilder="{Binding ContentBuilder}" />
                                    </Border>
                                    <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                               FontSize="11"
                                               Opacity="0.6"
                                               HorizontalAlignment="Right"
                                               Margin="0,5,0,0" />
                                </StackPanel>

                                <!-- AI åŠ©æ‰‹æ¶ˆæ¯ -->
                                <StackPanel IsVisible="{Binding IsAssistant}">
                                    <suki:GlassCard HorizontalAlignment="Left" MaxWidth="700">
                                        <StackPanel>
                                            <!-- æŽ¨ç†å†…å®¹ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰ -->
                                            <Border IsVisible="{Binding HasReasoning}"
                                                    Background="{DynamicResource SukiCardBackground}"
                                                    CornerRadius="8"
                                                    Padding="12"
                                                    Margin="0,0,0,10">
                                                <StackPanel>
                                                    <Button Content="{Binding IsReasoningExpanded, Converter={StaticResource ReasoningButtonConverter}}"
                                                            Command="{Binding $parent[UserControl].((vm:AiChatViewModel)DataContext).ToggleReasoningCommand}"
                                                            CommandParameter="{Binding}"
                                                            Classes="Basic"
                                                            HorizontalAlignment="Left"
                                                            Padding="8,4" />

                                                    <!-- å±•å¼€çš„æ€è€ƒå†…å®¹ -->
                                                    <Border IsVisible="{Binding IsReasoningExpanded}"
                                                            Margin="0,10,0,0">
                                                        <ScrollViewer MaxHeight="300" HorizontalScrollBarVisibility="Disabled">
                                                            <!-- Markdown æ¸²æŸ“å™¨ -->
                                                            <md:MarkdownRenderer MarkdownBuilder="{Binding ReasoningContentBuilder}" />
                                                        </ScrollViewer>
                                                    </Border>
                                                </StackPanel>
                                            </Border>

                                            <!-- å›žç­”å†…å®¹ -->
                                            <!-- Markdown æ¸²æŸ“å™¨ -->
                                            <md:MarkdownRenderer MarkdownBuilder="{Binding ContentBuilder}" />
                                        </StackPanel>
                                    </suki:GlassCard>

                                    <!-- æ—¶é—´æˆ³å’ŒçŠ¶æ€ -->
                                    <StackPanel Orientation="Horizontal"
                                               HorizontalAlignment="Left"
                                               Margin="15,5,0,0"
                                               Spacing="8">
                                        <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                                  FontSize="11"
                                                  Opacity="0.6" />

                                        <!-- AI çŠ¶æ€æ ‡è¯† -->
                                        <TextBlock Text="{Binding StatusText}"
                                                  FontSize="11"
                                                  Opacity="0.7"
                                                  Foreground="{DynamicResource SukiPrimaryColor}"
                                                  FontWeight="Medium"
                                                  IsVisible="{Binding ShowStatus}" />
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

        <!-- è¾“å…¥æ¡† -->
        <Border Grid.Row="2"
                Background="{DynamicResource SukiBackground}"
                BorderBrush="{DynamicResource SukiBorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="20">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
                <TextBox Grid.Column="0"
                         Text="{Binding InputMessage, Mode=TwoWay}"
                         Watermark="è¾“å…¥æ‚¨çš„ç¡¬ä»¶é…ç½®æˆ–è£…æœºéœ€æ±‚... (æ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒCtrl+Enter å‘é€)"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MaxHeight="120"
                         VerticalAlignment="Center">
                    <TextBox.KeyBindings>
                        <KeyBinding Gesture="Ctrl+Enter" Command="{Binding SendMessageCommand}" />
                    </TextBox.KeyBindings>
                </TextBox>

                <!-- æµ‹è¯•æŒ‰é’®ï¼ˆæ—  CanExecute æ£€æŸ¥ï¼‰ -->
                <Button Grid.Column="1"
                        Content="æµ‹è¯•"
                        Command="{Binding ClearMessagesCommand}"
                        Margin="10,0,0,0"
                        Classes="Basic"
                        VerticalAlignment="Center" />

                <!-- å‘é€æŒ‰é’® -->
                <Button Grid.Column="2"
                        Content="å‘é€"
                        Command="{Binding SendMessageCommand}"
                        Margin="10,0,0,0"
                        Classes="Accent"
                        VerticalAlignment="Center" />

                <!-- åœæ­¢æŒ‰é’® -->
                <Button Grid.Column="3"
                        Content="åœæ­¢"
                        Command="{Binding StopGenerationCommand}"
                        Margin="10,0,0,0"
                        Classes="Flat Accent"
                        VerticalAlignment="Center" />
            </Grid>
        </Border>
    </Grid>
</UserControl>
